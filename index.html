<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
    <base href="./" />
    <link rel="icon" href="assets/icons/redcap.png" />
    <title>Forest Pathways – Logic Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .overlay {
        opacity: 1;
        transition: opacity 200ms ease;
      }

      .overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .board-shake {
        animation: board-shake 300ms ease;
      }

      .board-glow-success {
        animation: board-glow-success 600ms ease;
      }

      .board-glow-error {
        animation: board-glow-error 600ms ease;
      }

      @keyframes board-shake {
        0% { transform: translateX(0); }
        20% { transform: translateX(-6px); }
        40% { transform: translateX(6px); }
        60% { transform: translateX(-4px); }
        80% { transform: translateX(4px); }
        100% { transform: translateX(0); }
      }

      @keyframes board-glow-success {
        0% { box-shadow: 0 0 0 rgba(16, 185, 129, 0); }
        30% { box-shadow: 0 0 24px rgba(16, 185, 129, 0.45); }
        100% { box-shadow: 0 0 0 rgba(16, 185, 129, 0); }
      }

      @keyframes board-glow-error {
        0% { box-shadow: 0 0 0 rgba(248, 113, 113, 0); }
        30% { box-shadow: 0 0 24px rgba(248, 113, 113, 0.45); }
        100% { box-shadow: 0 0 0 rgba(248, 113, 113, 0); }
      }

      .hero-pattern {
        background-color: #061008;
      }
      .parallax-bg {
        position: fixed;
        inset: 0;
        z-index: 0;
        background-image: radial-gradient(1200px 800px at 15% 10%, rgba(4, 50, 38, 0.14), transparent 55%),
          radial-gradient(900px 700px at 85% 25%, rgba(8, 55, 35, 0.1), transparent 50%),
          radial-gradient(600px 400px at 50% 60%, rgba(6, 78, 59, 0.06), transparent 45%),
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80' fill='none' stroke='%23122a18' stroke-width='0.5' stroke-opacity='0.05'%3E%3Cpath d='M0 20 Q20 12 40 20 T80 20'/%3E%3Cpath d='M0 35 Q25 45 40 35 T80 35'/%3E%3Cpath d='M0 50 Q20 42 40 50 T80 50'/%3E%3Cpath d='M0 65 Q30 55 40 65 T80 65'/%3E%3Cpath d='M20 0 Q30 20 20 40 T20 80'/%3E%3Cpath d='M45 0 Q55 25 45 40 T45 80'/%3E%3Cpath d='M70 0 Q60 22 70 40 T70 80'/%3E%3C/svg%3E");
        background-size: auto, auto, auto, 144px 144px;
        background-attachment: scroll;
        background-position: 0 0;
        pointer-events: none;
      }
      .fog {
        position: fixed;
        inset: 0;
        z-index: 1;
        pointer-events: none;
        background-image: radial-gradient(ellipse 140% 90% at 50% 95%, rgba(6, 78, 59, 0.08) 0%, transparent 40%),
          radial-gradient(ellipse 90% 70% at 15% 15%, rgba(4, 50, 38, 0.06) 0%, transparent 45%),
          radial-gradient(ellipse 90% 70% at 85% 25%, rgba(4, 50, 38, 0.06) 0%, transparent 45%);
      }

      .custom-scrollbar::-webkit-scrollbar {
        height: 4px;
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(4, 28, 20, 0.5);
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(22, 101, 52, 0.2);
        border-radius: 10px;
      }

      #toast {
        opacity: 0;
        transform: translate(-50%, 0.25rem);
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
      }
      #toast.toast-visible {
        opacity: 1;
        transform: translate(-50%, 0);
        pointer-events: auto;
      }
      #toast.toast--success { border-color: rgba(16, 185, 129, 0.5); background: rgba(5, 150, 105, 0.2); }
      #toast.toast--success #toastText { color: rgb(110, 231, 183); }
      #toast.toast--error { border-color: rgba(248, 113, 113, 0.5); background: rgba(225, 29, 72, 0.15); }
      #toast.toast--error #toastText { color: rgb(252, 165, 165); }
      #toast.toast--info { border-color: rgba(100, 116, 139, 0.5); background: rgba(51, 65, 85, 0.25); }
      #toast.toast--info #toastText { color: rgb(148, 163, 184); }

      html {
        height: 100%;
        overflow: hidden;
      }
      body {
        box-sizing: border-box;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        margin: 0;
        padding-top: env(safe-area-inset-top, 0);
        padding-bottom: env(safe-area-inset-bottom, 0);
        padding-left: env(safe-area-inset-left, 0);
        padding-right: env(safe-area-inset-right, 0);
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
      }
      /* Mobile: Reserve nur unten, damit Tile-Leiste nicht unter die Browser-Chrome fällt */
      @media (pointer: coarse), (max-height: 50rem) {
        body {
          padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 6.5rem);
        }
      }
      /* Footer: nur noch minimaler Abstand, Reserve ist schon am body */
      .footer-safe {
        padding-bottom: 0.75rem;
      }
      /* Main darf schrumpfen, damit Header + Main + Footer in die Höhe passen */
      .main-fill {
        min-height: 0;
      }
      /* Karte: Spielfeld + Tile-Leiste als ein Panel (oben/links/rechts ohne Abstand), Border wie Header/Footer */
      .board-card {
        touch-action: none;
        background: transparent;
        border: 1px solid rgb(20 83 45 / 0.5);
        box-shadow: inset 0 1px 0 0 rgba(34, 197, 94, 0.06);
      }
      .game-frame {
        touch-action: none;
      }
      /* Tile-Leiste: max. Höhe, bei vielen Tiles oder kleinem Screen vertikal scrollbar */
      #tileList {
        max-height: min(5rem, 20vh);
        overflow-y: auto;
      }
      /* Tile-Cards: Touch nicht als Scroll; Mindesthöhe für Touch-Ziel (~44px) */
      .tile-card {
        touch-action: none;
        min-height: 2.75rem;
      }
      /* Sehr kleine Viewports: Tile-Cards etwas kleiner für mehr Platz */
      @media (max-height: 30rem) {
        .tile-card {
          height: 3rem;
          min-width: 4rem;
          width: 4rem;
        }
      }
      /* Disabled state for board and header buttons */
      .board-action-btn:disabled, .header-icon-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }
      .board-action-btn--checking {
        pointer-events: none;
        animation: btn-pulse 0.6s ease-in-out infinite;
      }
      @keyframes btn-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      /* Mobile: größere Touch-Ziele (~44px) und Lesbarkeit */
      @media (pointer: coarse), (max-width: 640px) {
        .header-icon-btn { min-height: 2.75rem; min-width: 2.75rem; }
        .board-action-btn { min-height: 2.75rem; padding-left: 1rem; padding-right: 1rem; padding-top: 0.625rem; padding-bottom: 0.625rem; font-size: 0.875rem; }
        .status-text-touch { font-size: 0.75rem; }
      }

      /* Start overlay: controls hint by device (touch vs pointer) */
      .overlay-controls-touch { display: none; }
      .overlay-controls-pointer { display: block; }
      @media (pointer: coarse) {
        .overlay-controls-touch { display: block; }
        .overlay-controls-pointer { display: none; }
      }
      /* A11y: sichtbare Fokus-Ringe für Tastatur */
      .focus-ring:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px #061008, 0 0 0 4px rgba(52, 211, 153, 0.8);
      }
      /* Level-Picker: aktueller Level grüner Hintergrund, weiße fette Schrift */
      .level-list-item.level-current {
        background: rgb(5 150 105);
        border-color: rgb(5 150 105);
        color: #fff;
        font-weight: 700;
      }
      .level-list-item.level-current .level-list-badge {
        color: #fff;
        font-weight: 700;
      }
    </style>
  </head>
  <body class="hero-pattern min-h-screen overflow-hidden text-slate-100 touch-none box-border">
    <div id="parallaxBg" class="parallax-bg" aria-hidden="true"></div>
    <div class="fog" aria-hidden="true"></div>
    <div class="flex h-full w-full flex-col overflow-hidden relative z-10">
      <!-- HEADER -->
      <header class="z-10 flex flex-shrink-0 items-center justify-between border-b border-green-900/50 bg-[rgba(4,28,20,0.7)] py-3 px-3 sm:px-4 backdrop-blur-md">
        <div class="flex items-center gap-3 min-w-0 flex-1">
          <img src="assets/Logo.webp" alt="Logo" class="h-8 sm:h-10 object-contain flex-shrink-0" />
          <div class="h-4 w-px bg-green-800/40 hidden sm:block flex-shrink-0"></div>
          <div class="hidden flex-col sm:flex flex-shrink-0">
             <span id="difficultyBadge" class="text-[9px] font-bold uppercase tracking-widest text-emerald-400"></span>
             <span id="modeLabel" class="text-[9px] font-medium uppercase tracking-widest text-slate-400"></span>
          </div>
        </div>

        <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
          <button id="levelPickerBtn" class="focus-ring header-icon-btn flex h-8 w-8 sm:h-8 sm:w-8 items-center justify-center rounded-full text-slate-400 transition hover:bg-green-800/50 hover:text-emerald-400 active:scale-90" title="Choose level" aria-label="Choose level">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
          </button>
          <button id="resetBtn" class="focus-ring header-icon-btn flex h-8 w-8 sm:h-8 sm:w-8 items-center justify-center rounded-full text-slate-400 transition hover:bg-green-800/50 hover:text-rose-400 active:scale-90" title="Reset">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></svg>
          </button>
          <button id="hintBtn" class="focus-ring header-icon-btn flex h-8 w-8 sm:h-8 sm:w-8 items-center justify-center rounded-full text-slate-400 transition hover:bg-green-800/50 hover:text-amber-400 active:scale-90" title="Hint">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></svg>
          </button>
          <button id="musicMuteBtn" class="focus-ring header-icon-btn flex h-8 w-8 sm:h-8 sm:w-8 items-center justify-center rounded-full text-slate-400 transition hover:bg-green-800/50 hover:text-slate-100 active:scale-90" title="Music on/off">
            <svg id="musicMuteOnIcon" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>
            <svg id="musicMuteOffIcon" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
          </button>
        </div>
      </header>

      <!-- MAIN AREA: Karte (Spielfeld + Footer) ohne Außenpadding -->
      <main class="main-fill relative flex flex-1 flex-col overflow-hidden w-full">
        <div class="board-card relative flex flex-1 flex-col min-h-0 w-full overflow-hidden">
        <div class="game-frame relative flex min-h-0 flex-1 items-center justify-center overflow-hidden">
          <canvas id="board" width="640" height="640" aria-label="Redcape Board" class="block h-auto w-full max-h-full object-contain"></canvas>

          <!-- Rotate + Check als Overlay auf dem Spielfeld -->
          <div class="absolute bottom-3 left-1/2 z-10 flex -translate-x-1/2 items-center gap-3 pointer-events-none">
            <div class="pointer-events-auto flex items-center gap-3 rounded-full border border-green-900/50 bg-[rgba(4,28,20,0.9)] px-3 py-2 shadow-xl backdrop-blur-sm">
              <button id="rotateBtn" class="focus-ring board-action-btn flex h-9 items-center gap-2 rounded-full bg-green-950 px-4 text-xs sm:text-sm font-bold text-slate-100 transition hover:bg-green-900 active:scale-95" title="Rotate">
                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /></svg>
                <span>Rotate</span>
              </button>
              <button id="checkBtn" class="focus-ring board-action-btn flex h-9 items-center gap-2 rounded-full bg-emerald-600 px-5 text-xs sm:text-sm font-bold text-white transition hover:bg-emerald-500 active:scale-95 shadow-lg shadow-emerald-950/40" type="button" title="Check">
                <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5" /></svg>
                <span>CHECK</span>
              </button>
            </div>
          </div>

          <!-- Overlay Messages -->
          <div id="overlay" class="overlay absolute inset-0 z-20 grid place-items-center bg-[rgba(6,16,8,0.92)] p-4">
            <div class="max-w-xs rounded-2xl border border-green-900/50 bg-[rgba(4,28,20,0.98)] p-6 text-center shadow-2xl">
              <h2 id="overlayTitle" class="text-xl font-semibold text-slate-100">Ready?</h2>
              <p id="overlayText" class="mt-2 text-sm text-slate-300">Choose a challenge and start.</p>
              <div class="mt-4 pt-4 border-t border-green-900/50 text-left">
                <p class="text-[10px] font-semibold uppercase tracking-widest text-slate-500 mb-1.5">Controls</p>
                <p class="overlay-controls-touch text-xs text-slate-400">Tap a tile to select, drag onto the board to place. Double-tap a tile to rotate. Use <strong class="text-slate-300">Rotate</strong> to turn. Drag off the board to remove.</p>
                <p class="overlay-controls-pointer text-xs text-slate-400">Click a tile to select, drag onto the board to place. Use <strong class="text-slate-300">Rotate</strong> to turn. Drag off the board to remove.</p>
              </div>
              <button
                id="overlayBtn"
                class="focus-ring mt-6 w-full rounded-full bg-emerald-600 px-6 py-3 text-sm font-bold text-white transition hover:bg-emerald-500 active:scale-95 shadow-lg shadow-emerald-950/40"
                type="button"
              >
                Play now
              </button>
            </div>
          </div>
        </div>
        <!-- Footer (Tile-Leiste) in der Karte -->
        <footer class="footer-safe z-10 flex flex-shrink-0 flex-col border-t border-green-900/50 bg-[rgba(4,28,20,0.7)] p-3 pt-3 backdrop-blur-sm">
          <div id="tileList" class="custom-scrollbar flex min-h-[3.5rem] flex-wrap items-center justify-center gap-2 overflow-x-auto overflow-y-auto px-2 py-1">
            <!-- Tiles will be injected here -->
          </div>
        </footer>
        </div>
      </main>

      <!-- Toast: fest über den Rotate/Check-Buttons, unabhängig, eine Zeile -->
      <div id="toast" class="fixed bottom-44 left-1/2 z-50 rounded-full border border-green-900/50 bg-[rgba(4,28,20,0.95)] px-3 py-1.5 shadow-md backdrop-blur-sm whitespace-nowrap" role="status" aria-live="polite">
        <p id="toastText" class="text-[9px] font-semibold uppercase tracking-wider"></p>
      </div>

      <!-- Level Picker Overlay -->
      <div id="levelOverlay" class="overlay hidden absolute inset-0 z-30 grid place-items-center bg-[rgba(6,16,8,0.92)] p-4 backdrop-blur-sm">
        <div class="max-w-sm w-full rounded-2xl border border-green-900/50 bg-[rgba(4,28,20,0.98)] p-6 shadow-2xl max-h-[80vh] flex flex-col">
          <div class="flex items-center justify-between mb-4 flex-shrink-0">
            <h2 class="text-xl font-semibold text-slate-100">Choose level</h2>
            <button id="closeLevelOverlayBtn" class="focus-ring p-2 rounded-full text-slate-500 hover:text-slate-100 transition" aria-label="Close"><svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg></button>
          </div>
          <div id="levelList" class="custom-scrollbar overflow-y-auto space-y-1 min-h-0">
            <!-- Levels injected by app.js -->
          </div>
        </div>
      </div>

      <!-- Help Overlay (Minimal) -->
      <div id="helpOverlay" class="overlay hidden absolute inset-0 z-30 grid place-items-center bg-[rgba(6,16,8,0.92)] p-4 backdrop-blur-sm">
        <div class="max-w-lg w-full rounded-2xl border border-green-900/50 bg-[rgba(4,28,20,0.98)] p-6 shadow-2xl max-h-[80vh] overflow-y-auto custom-scrollbar">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-100">How to Play</h2>
            <button id="closeHelpBtn" class="focus-ring p-2 rounded-full text-slate-500 hover:text-slate-100 transition"><svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg></button>
          </div>
          <div class="space-y-4 text-sm text-slate-400 leading-relaxed">
            <p>Connect pathways from Red Riding Hood to the house.</p>
            <ul class="list-disc ml-5 space-y-1">
              <li><strong class="text-slate-200">Drag</strong> tiles to place them.</li>
              <li><strong class="text-slate-200">Tap</strong> to select, use <strong class="text-slate-200">Rotate</strong> button to turn.</li>
              <li><strong class="text-slate-200">With Wolf:</strong> Create two separate paths. Wolf's path must be shorter.</li>
              <li><strong class="text-slate-200">Outside:</strong> Drag a tile off the board to remove it.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="data/challenges.inline.js"></script>
    <script src="scripts/logic-core.js"></script>
    <script src="scripts/solver-engine.js"></script>
    <script src="app.js" defer></script>
  </body>
</html>
